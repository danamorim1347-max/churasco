<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Grill Master | Churrascaria & Delivery</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#8B4513">
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Grill%20Master%22%2C%22short_name%22%3A%22Grill%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23f9f3e9%22%2C%22theme_color%22%3A%22%238B4513%22%7D">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=Anton&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background: #f9f3e9; -webkit-tap-highlight-color: transparent; overflow-x: hidden; font-size: 14px; }
        .font-anton { font-family: 'Anton', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .hidden { display: none !important; }
        .tab-active { background-color: #8B4513 !important; color: white !important; font-weight: 800; border-radius: 12px; }
        .cat-active { background-color: #2c1810 !important; color: #d4a373 !important; border-color: #2c1810 !important; }
        
        .header-banner { position: relative; width: 100%; height: 210px; overflow: hidden; background: linear-gradient(45deg, #2c1810 0%, #8B4513 100%); }
        .header-banner img { width: 100%; height: 100%; object-fit: cover; opacity: 0.7; }
        .header-overlay { position: absolute; bottom: 0; left: 0; right: 0; padding: 25px 20px; background: linear-gradient(to top, #f9f3e9 5%, rgba(44,24,16,0.9) 60%, transparent); }

        .status-Novo { border-left: 12px solid #b22222 !important; background-color: #fee ; }
        .status-Preparando { border-left: 12px solid #cd5c1f !important; background-color: #fff1e0; }
        .status-Assando { border-left: 12px solid #d97706 !important; background-color: #fffbeb; }
        .status-Pronto { border-left: 12px solid #2e7d32 !important; background-color: #e8f5e9; }
        .status-Saiu { border-left: 12px solid #0d47a1 !important; background-color: #e3f2fd; }
        .status-Finalizado { border-left: 12px solid #6a1b9a !important; background-color: #f3e5f5; opacity: 0.7; }
        .status-Cancelado { border-left: 12px solid #5d4037 !important; background-color: #efebe9; opacity: 0.5; }

        @media print {
            header, nav, main, #cart-fixed, #modal-checkout, #view-admin, #view-login, #view-acompanhar, #modal-carrinho, #modal-detalhes-produto, #modal-editar-prod, #modal-editar-promocao, #modal-editar-tamanho, #modal-sabores-promocao, button, select, i, .no-print { 
                display: none !important; 
            }
            #secao-impressao { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100% !important; 
                background: white; 
                padding: 0; 
                margin: 0; 
                font-size: 12px;
            }
            body * {
                visibility: hidden;
            }
            #secao-impressao, #secao-impressao * {
                visibility: visible;
            }
        }

        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2e7d32; }
        input:checked + .slider:before { transform: translateX(18px); }
        
        .loading { opacity: 0.6; pointer-events: none; }
        .loading::after { content: '...'; animation: dots 1.5s infinite; }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60%, 100% { content: '...'; } }
        
        #initial-loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #f9f3e9; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; }
        
        .meat-shadow { box-shadow: 0 4px 20px rgba(139, 69, 19, 0.3); }
        .meat-gradient { background: linear-gradient(135deg, #b22222 0%, #8B4513 100%); }
        .text-meat { color: #8B4513; }
        .bg-meat-light { background-color: #f9f3e9; }
        .border-meat { border-color: #d4a373; }
        
        .clickable { cursor: pointer; }
        .clickable:hover { transform: translateY(-2px); transition: transform 0.2s; }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-slideDown {
            animation: slideDown 0.3s ease-out;
        }
        
        @media (max-width: 640px) {
            .header-banner { height: 180px !important; }
            .header-overlay { padding: 15px !important; }
            #cli-nome { font-size: 1.75rem !important; }
            #cli-status-loja { font-size: 8px !important; padding: 3px 10px !important; margin-top: 1px !important; }
            #cardapio > div { padding: 12px !important; gap: 12px !important; margin-bottom: 8px !important; }
            #cardapio .w-20 { width: 60px !important; height: 60px !important; }
            button:not(.switch) { padding: 12px !important; }
            #filtros { padding: 10px 15px !important; }
            #filtros button { padding: 6px 12px !important; font-size: 9px !important; }
            #cart-fixed button { padding: 12px 16px !important; font-size: 10px !important; }
            #modal-checkout, #modal-carrinho { padding: 20px !important; }
            #modal-checkout h2, #modal-carrinho h2 { font-size: 1.25rem !important; }
            input, select { padding: 12px !important; font-size: 14px !important; }
            #view-admin { padding-bottom: 10px !important; }
            .flex-1.p-4 { padding: 12px 8px !important; font-size: 8px !important; }
            #promocao-container div { padding: 12px !important; }
            #cart-fixed { bottom: 10px !important; padding: 0 10px !important; }
            #cart-fixed button { padding: 10px 14px !important; font-size: 9px !important; border-radius: 20px !important; }
            #modal-checkout .max-h-\[94vh\] { max-height: 85vh !important; }
            #carrinho-itens-list > div { padding: 10px !important; margin-bottom: 6px !important; }
        }
        
        #view-cliente, #view-admin, #view-acompanhar { max-width: 100% !important; padding-left: 0; padding-right: 0; }
        header.p-4 { padding: 12px !important; }
    </style>
</head>
<body class="flex justify-center">
    <!-- Loading inicial -->
    <div id="initial-loading" class="bg-amber-50">
        <div class="text-center">
            <div class="text-4xl mb-4">ü•©</div>
            <h2 class="text-xl font-anton text-amber-800 mb-2">GRILL MASTER</h2>
            <div class="text-amber-600 text-sm">Carregando sistema...</div>
        </div>
    </div>

    <audio id="alerta-som" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="secao-impressao" class="hidden font-mono text-[13px] leading-tight text-black bg-white p-4">
        <div id="print-content"></div>
    </div>

    <!-- MODAL LOGIN ADM -->
    <div id="view-login" class="hidden fixed inset-0 bg-black/95 z-[150] flex items-center justify-center p-6 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm p-8 rounded-[40px] text-center shadow-2xl">
            <h2 class="text-2xl font-anton uppercase mb-6 text-amber-800">Login Administrativo</h2>
            <input id="login-email" type="email" placeholder="Email ADM" class="w-full p-4 bg-amber-50 rounded-2xl border-none outline-none mb-3 text-sm">
            <input id="login-pass" type="password" placeholder="Senha ADM" class="w-full p-4 bg-amber-50 rounded-2xl border-none outline-none mb-4 text-sm">
            <button onclick="login()" class="w-full bg-amber-800 text-white p-4 rounded-2xl font-black uppercase shadow-lg hover:bg-amber-900 transition">Entrar no Painel</button>
            <button onclick="fecharLogin()" class="mt-4 text-gray-400 text-xs font-bold uppercase underline">Voltar</button>
            <div id="login-error" class="mt-3 text-red-500 text-xs hidden"></div>
        </div>
    </div>

    <!-- RASTREIO CLIENTE -->
    <div id="view-acompanhar" class="hidden w-full max-w-md min-h-screen p-6 text-center bg-white">
        <div class="py-10">
            <h2 class="text-2xl font-anton text-amber-800 mb-6 uppercase">Acompanhe Seu Pedido</h2>
            <div id="box-status-cliente" class="py-16 px-4 rounded-[40px] border-4 border-double mb-8 transition-all duration-500 shadow-inner bg-amber-50">
                <h3 id="rastreio-status" class="text-3xl font-anton uppercase text-gray-800">---</h3>
                <div id="rastreio-tempo" class="text-sm text-amber-800 mt-2">Tempo estimado: 40-50 min</div>
            </div>
            <button onclick="location.reload()" class="w-full bg-gray-900 text-amber-400 p-5 rounded-2xl font-black shadow-lg uppercase hover:bg-black transition">üîÑ Atualizar Status</button>
            <button onclick="location.href=location.pathname" class="mt-8 text-gray-400 font-bold text-xs uppercase underline">Fazer novo pedido</button>
        </div>
    </div>

    <!-- VIS√ÉO CLIENTE -->
    <div id="view-cliente" class="w-full max-w-md min-h-screen pb-32 bg-amber-50 shadow-2xl">
        <header class="header-banner">
            <img id="cli-logo" src="https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=800&auto=format&fit=crop&q=80" alt="Churrascaria">
            <div class="header-overlay">
                <h1 id="cli-nome" class="text-3xl font-anton uppercase text-white tracking-wider drop-shadow-lg">GRILL MASTER</h1>
                <div id="cli-status-loja" class="inline-block px-4 py-1.5 rounded-full text-[9px] font-black mt-2 border border-amber-300 uppercase italic backdrop-blur-md text-amber-300">‚óè ABERTO AGORA</div>
                <div class="text-xs text-amber-200 mt-1">Entrega 40-50 min ‚Ä¢ Pedido m√≠nimo R$ 35</div>
            </div>
            <button onclick="abrirLogin()" class="absolute top-6 right-6 text-amber-200 text-xl hover:text-white transition"><i class="fas fa-cog"></i></button>
        </header>

        <nav id="filtros" class="flex gap-2 p-5 overflow-x-auto no-scrollbar sticky top-0 z-20 bg-amber-50/95 backdrop-blur-sm mt-2 border-b border-amber-200"></nav>
        <main id="cardapio" class="px-5 space-y-3 mt-2 text-black"></main>

        <div id="cart-fixed" class="fixed bottom-6 left-0 right-0 px-6 hidden z-30 flex justify-center">
            <button onclick="abrirCarrinho()" class="w-full max-w-md bg-gray-900 text-amber-400 py-5 rounded-[25px] font-black flex justify-between px-8 shadow-2xl items-center border-b-4 border-amber-800 transition active:scale-95">
                <span class="text-xs uppercase tracking-widest">Ver Carrinho</span>
                <span id="cart-total-display" class="bg-amber-800 text-white px-3 py-1 rounded-lg text-sm font-black italic">R$ 0,00</span>
            </button>
        </div>
    </div>

    <!-- MODAL CARRINHO -->
    <div id="modal-carrinho" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-[45px] p-7 space-y-4 max-h-[94vh] overflow-y-auto shadow-2xl text-black">
            <div class="flex justify-between items-center font-anton uppercase text-xl text-amber-800">
                <h2>Meu Carrinho</h2>
                <button onclick="fecharCarrinho()" class="text-2xl text-gray-300">‚úï</button>
            </div>
            
            <div id="carrinho-itens-list" class="space-y-3"></div>
            
            <div id="carrinho-vazio" class="text-center py-10">
                <div class="text-4xl mb-4">üõí</div>
                <p class="text-gray-500 font-bold">Carrinho vazio</p>
                <p class="text-gray-400 text-sm">Adicione produtos para continuar</p>
            </div>
            
            <div class="bg-gray-900 text-white p-6 rounded-[35px] shadow-xl font-black italic uppercase">
                <div class="flex justify-between text-2xl text-amber-400 tracking-tighter">
                    <span>Total:</span>
                    <span id="carrinho-total">R$ 0,00</span>
                </div>
            </div>
            
            <div class="flex gap-2">
                <button onclick="fecharCarrinho()" class="flex-1 bg-gray-200 text-gray-800 py-4 rounded-[25px] font-bold uppercase text-sm">Continuar Comprando</button>
                <button onclick="checkout()" class="flex-1 bg-green-600 text-white py-4 rounded-[25px] font-bold uppercase text-sm hover:bg-green-700 transition">Finalizar Pedido</button>
            </div>
        </div>
    </div>

    <!-- MODAL CHECKOUT -->
    <div id="modal-checkout" class="fixed inset-0 bg-black/80 z-50 hidden flex items-end justify-center">
        <div class="bg-white w-full max-w-md rounded-t-[45px] p-7 space-y-4 max-h-[94vh] overflow-y-auto shadow-2xl text-black">
            <div class="flex justify-between items-center font-anton uppercase text-xl text-amber-800">
                <h2>Finalizar Pedido</h2>
                <button onclick="fecharCheckout()" class="text-2xl text-gray-300">‚úï</button>
            </div>
            
            <div id="checkout-itens-list" class="bg-amber-50 p-4 rounded-3xl border border-amber-100 space-y-2 text-[10px] font-bold text-gray-600 italic"></div>

            <div class="space-y-2.5">
                <input id="f-nome" type="text" placeholder="Seu Nome Completo" class="w-full p-4 bg-amber-50 rounded-2xl border-none outline-none font-bold text-sm">
                <input id="f-whatsapp" type="tel" placeholder="WhatsApp (Ex: 85999999999)" class="w-full p-4 bg-amber-50 rounded-2xl border-none outline-none font-bold text-sm">
                
                <div id="area-endereco">
                    <div class="grid grid-cols-4 gap-2">
                        <input id="f-rua" type="text" placeholder="Rua" class="col-span-3 p-4 bg-amber-50 rounded-2xl outline-none text-sm">
                        <input id="f-num" type="text" placeholder="N¬∫" class="col-span-1 p-4 bg-amber-50 rounded-2xl outline-none text-center text-sm">
                    </div>
                    <input id="f-bairro" type="text" placeholder="Bairro" class="w-full p-4 bg-amber-50 rounded-2xl outline-none text-sm mt-2">
                </div>
                
                <input id="f-comp" type="text" placeholder="Complemento / Refer√™ncia" class="w-full p-4 bg-amber-50 rounded-2xl outline-none text-sm">

                <div class="flex gap-2">
                    <input id="f-cupom" type="text" placeholder="Cupom" class="flex-1 p-4 bg-amber-50 rounded-2xl outline-none text-sm uppercase font-black">
                    <button onclick="aplicarCupom()" class="bg-amber-200 text-amber-800 px-4 rounded-2xl font-black text-[10px] uppercase">Validar</button>
                </div>

                <select id="f-pag" class="w-full p-4 bg-amber-50 rounded-2xl font-bold border text-sm">
                    <option value="Pix">Pix</option>
                    <option value="Cart√£o">Cart√£o D√©bito/Cr√©dito</option>
                    <option value="Dinheiro">Dinheiro</option>
                </select>
                <div id="div-troco" class="hidden"><input id="f-troco" type="number" placeholder="Troco para quanto?" class="w-full p-4 bg-orange-50 border-2 border-orange-100 rounded-2xl font-bold text-sm"></div>
            </div>

            <div class="bg-gray-900 text-white p-6 rounded-[35px] shadow-xl font-black italic uppercase">
                <div id="div-desconto-txt" class="hidden flex justify-between text-[10px] text-green-400 mb-1">
                    <span>Desconto Cupom:</span><span id="txt-val-cupom">-R$ 0,00</span>
                </div>
                <div class="flex justify-between text-2xl text-amber-400 tracking-tighter">
                    <span>Total Final:</span>
                    <span id="res-total">R$ 0,00</span>
                </div>
            </div>
            <button onclick="finalizarPedido()" class="w-full bg-green-600 text-white py-6 rounded-[25px] font-black uppercase tracking-widest border-b-4 border-green-800 shadow-xl">üöÄ FINALIZAR PEDIDO</button>
        </div>
    </div>

    <!-- PAINEL ADM -->
    <div id="view-admin" class="hidden w-full max-w-4xl mx-auto min-h-screen pb-20 bg-amber-50">
        <header class="bg-gray-900 text-amber-400 p-4 flex justify-between items-center sticky top-0 z-50">
            <h1 class="font-anton text-amber-400 uppercase tracking-tighter text-xl">PAINEL GRILL MASTER</h1>
            <div class="flex items-center gap-3">
                <span id="admin-user" class="text-[10px] text-amber-300"></span>
                <button onclick="logout()" class="text-[9px] font-bold border border-amber-400 text-amber-400 px-3 py-1 rounded-full uppercase hover:bg-amber-400 hover:text-gray-900 transition">Sair</button>
            </div>
        </header>
        
        <div class="flex bg-white border-b border-amber-200 sticky top-14 z-40 overflow-x-auto no-scrollbar shadow-sm">
            <button onclick="ativarAba('pedidos')" id="tab-pedidos" class="flex-1 p-4 font-bold text-[9px] tab-active uppercase">üìã Pedidos</button>
            <button onclick="ativarAba('produtos')" id="tab-produtos" class="flex-1 p-4 font-bold text-[9px] uppercase text-gray-400">ü•© Card√°pio</button>
            <button onclick="ativarAba('categorias')" id="tab-categorias" class="flex-1 p-4 font-bold text-[9px] uppercase text-gray-400">üìÅ Categorias</button>
            <button onclick="ativarAba('cupons')" id="tab-cupons" class="flex-1 p-4 font-bold text-[9px] uppercase text-gray-400">üé´ Cupons</button>
            <button onclick="ativarAba('config')" id="tab-config" class="flex-1 p-4 font-bold text-[9px] uppercase whitespace-nowrap tracking-tighter text-gray-400">‚öôÔ∏è Config</button>
            <button onclick="sincronizarCardapio()" class="flex-1 p-4 font-bold text-[9px] uppercase text-green-600 hover:text-green-700">üîÑ Sincronizar</button>
        </div>
        
        <div id="adm-content" class="p-4 space-y-4">
            <div id="sec-pedidos" class="space-y-4 text-black"></div>
            <div id="sec-produtos" class="hidden space-y-4 text-black"></div>
            <div id="sec-categorias" class="hidden space-y-4 text-black"></div>
            <div id="sec-cupons" class="hidden space-y-4 text-black"></div>
            <div id="sec-config" class="hidden space-y-4 text-black"></div>
        </div>
    </div>

    <!-- Modal de progresso -->
    <div id="modal-progresso" class="hidden fixed inset-0 bg-black/80 z-[1000] flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-[40px] p-6 shadow-2xl text-center">
            <h3 class="font-anton text-xl text-amber-800 mb-4">Processando</h3>
            <div class="mb-4">
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="barra-progresso" class="bg-amber-800 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>
            <p id="status-progresso" class="text-sm text-gray-600 mb-2">Iniciando...</p>
            <p id="detalhe-progresso" class="text-xs text-gray-400"></p>
        </div>
    </div>

    <!-- FIREBASE SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, 
            query, where, orderBy, limit, onSnapshot, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCA-QxA-iOmdAaLGow8-iCYEa0TFyt_SnM",
            authDomain: "churrasco-8a27a.firebaseapp.com",
            projectId: "churrasco-8a27a",
            storageBucket: "churrasco-8a27a.firebasestorage.app",
            messagingSenderId: "1044993019977",
            appId: "1:1044993019977:web:c8a1b8dae0e6542850af98",
            measurementId: "G-RXNNTH3DEN"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        
        window.firebase = {
            addDoc, getDocs, doc, getDoc, setDoc, updateDoc, deleteDoc, collection,
            query, where, orderBy, limit, onSnapshot, serverTimestamp,
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged
        };

        console.log("‚úÖ Firebase pronto");
        window.dispatchEvent(new CustomEvent('firebaseReady'));
    </script>

    <script>
    // ==================== VARI√ÅVEIS GLOBAIS ====================
    let PRODS = [];
    let CATS = [];
    let CARRINHO = [];
    let CUPONS = [];
    let PEDIDOS = [];
    let curCat = 'todos';
    let usuarioAtual = null;
    let totalPedido = 0;
    let desconto = 0;
    let cupomAplicado = null;

    // ==================== INICIALIZA√á√ÉO ====================
    window.addEventListener('firebaseReady', async () => {
        document.getElementById('initial-loading').style.display = 'none';
        await carregarCategorias();
        await carregarProdutos();
        await carregarCupons();
        
        // Verificar se usu√°rio est√° logado
        firebase.onAuthStateChanged(window.auth, (user) => {
            if (user) {
                usuarioAtual = user;
                document.getElementById('admin-user').innerText = user.email;
            }
        });
    });

    // ==================== FUN√á√ïES DE UTILIDADE ====================
    function notificar(titulo, msg, tipo = 'info') {
        const div = document.createElement('div');
        div.className = `fixed top-4 left-1/2 transform -translate-x-1/2 z-[2000] px-6 py-4 rounded-2xl shadow-2xl text-white font-bold text-sm max-w-[90%] text-center animate-slideDown ${
            tipo === 'sucesso' ? 'bg-green-600' : tipo === 'erro' ? 'bg-red-600' : 'bg-amber-800'
        }`;
        div.innerHTML = `<div class="font-black mb-1">${titulo}</div><div>${msg}</div>`;
        document.body.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    function prog(titulo) {
        document.getElementById('modal-progresso').classList.remove('hidden');
        document.getElementById('status-progresso').innerText = titulo;
        document.getElementById('barra-progresso').style.width = '0%';
        document.getElementById('detalhe-progresso').innerText = '';
    }

    function progAtualizar(p, status, det = '') {
        document.getElementById('barra-progresso').style.width = p + '%';
        document.getElementById('status-progresso').innerText = status;
        document.getElementById('detalhe-progresso').innerText = det;
    }

    function progEsconder() {
        document.getElementById('modal-progresso').classList.add('hidden');
    }

    // ==================== FIREBASE - LEITURAS ====================
    async function carregarCategorias() {
        try {
            const q = query(collection(window.db, "categorias"), orderBy("ordem"));
            const snapshot = await firebase.getDocs(q);
            CATS = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderFiltros();
        } catch (e) {
            console.error("Erro ao carregar categorias:", e);
        }
    }

    async function carregarProdutos() {
        try {
            const snapshot = await firebase.getDocs(collection(window.db, "produtos"));
            PRODS = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            renderCardapio();
        } catch (e) {
            console.error("Erro ao carregar produtos:", e);
        }
    }

    async function carregarCupons() {
        try {
            const snapshot = await firebase.getDocs(collection(window.db, "cupons"));
            CUPONS = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        } catch (e) {
            console.error("Erro ao carregar cupons:", e);
        }
    }

    // ==================== LOGIN ====================
    window.abrirLogin = () => document.getElementById('view-login').classList.remove('hidden');
    window.fecharLogin = () => document.getElementById('view-login').classList.add('hidden');

    window.login = async function() {
        const email = document.getElementById('login-email').value;
        const senha = document.getElementById('login-pass').value;
        const errorDiv = document.getElementById('login-error');
        
        if (!email || !senha) {
            errorDiv.textContent = "Preencha email e senha!";
            errorDiv.classList.remove('hidden');
            return;
        }

        try {
            const userCredential = await firebase.signInWithEmailAndPassword(window.auth, email, senha);
            usuarioAtual = userCredential.user;
            
            document.getElementById('view-login').classList.add('hidden');
            document.getElementById('view-cliente').classList.add('hidden');
            document.getElementById('view-admin').classList.remove('hidden');
            document.getElementById('admin-user').innerText = usuarioAtual.email;
            
            notificar('Login', 'Bem-vindo ao painel!', 'sucesso');
            await carregarPedidos();
        } catch (error) {
            errorDiv.textContent = "Erro: " + error.message;
            errorDiv.classList.remove('hidden');
        }
    };

    window.logout = function() {
        firebase.signOut(window.auth).then(() => {
            usuarioAtual = null;
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('view-cliente').classList.remove('hidden');
            notificar('Logout', 'Sess√£o encerrada', 'info');
        });
    };

    // ==================== CARD√ÅPIO ====================
    function renderFiltros() {
        const div = document.getElementById('filtros');
        if (!div) return;
        
        let html = `<button onclick="filtrar('todos')" class="whitespace-nowrap px-4 py-2 text-[10px] font-black uppercase border rounded-full ${curCat === 'todos' ? 'cat-active' : 'border-amber-200 text-gray-400'}">Todos</button>`;
        
        CATS.forEach(c => {
            html += `<button onclick="filtrar('${c.id}')" class="whitespace-nowrap px-4 py-2 text-[10px] font-black uppercase border rounded-full ${curCat === c.id ? 'cat-active' : 'border-amber-200 text-gray-400'}">${c.nome}</button>`;
        });
        
        div.innerHTML = html;
    }

    window.filtrar = function(catId) {
        curCat = catId;
        renderFiltros();
        renderCardapio();
    };

    function renderCardapio() {
        const div = document.getElementById('cardapio');
        if (!div) return;
        
        const prods = curCat === 'todos' 
            ? PRODS.filter(p => p.disponivel !== false)
            : PRODS.filter(p => p.categoria_id === curCat && p.disponivel !== false);
        
        if (prods.length === 0) {
            div.innerHTML = '<div class="text-center py-10 text-gray-400 text-sm">Nenhum produto dispon√≠vel.</div>';
            return;
        }
        
        let html = '';
        prods.forEach(p => {
            const cat = CATS.find(c => c.id === p.categoria_id);
            html += `
            <div class="bg-white rounded-[20px] meat-shadow p-4 flex gap-4 border border-amber-100 items-center">
                <div class="w-20 h-20 rounded-xl overflow-hidden flex-shrink-0">
                    <img src="${p.imagem_url || 'https://cdn-icons-png.flaticon.com/512/3075/3075977.png'}" class="w-full h-full object-cover" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3075/3075977.png'">
                </div>
                <div class="flex-1">
                    <h3 class="font-black text-[11px] uppercase text-gray-800">${p.nome}</h3>
                    <p class="text-[9px] text-gray-400 line-clamp-1 mb-1">${p.descricao || ''}</p>
                    <div class="flex justify-between items-center mt-2">
                        <span class="text-amber-800 font-black text-md">R$ ${Number(p.preco).toFixed(2).replace('.',',')}</span>
                        <button onclick="addCarrinho('${p.id}')" class="bg-amber-800 text-white w-8 h-8 rounded-xl font-black text-xl shadow hover:bg-amber-900">+</button>
                    </div>
                </div>
            </div>`;
        });
        
        div.innerHTML = html;
    }

    window.addCarrinho = function(id) {
        const p = PRODS.find(p => p.id === id);
        if (!p) return;
        
        CARRINHO.push({
            id: p.id,
            nome: p.nome,
            preco: p.preco,
            descricao: p.descricao
        });
        
        atualizarCarrinho();
        notificar('Adicionado', `${p.nome} adicionado!`, 'sucesso');
    };

    function atualizarCarrinho() {
        const total = CARRINHO.reduce((acc, i) => acc + i.preco, 0);
        document.getElementById('cart-total-display').innerText = `R$ ${total.toFixed(2).replace('.',',')}`;
        document.getElementById('cart-fixed').classList.toggle('hidden', CARRINHO.length === 0);
    }

    window.abrirCarrinho = function() {
        if (CARRINHO.length === 0) {
            document.getElementById('carrinho-vazio').classList.remove('hidden');
            document.getElementById('carrinho-itens-list').innerHTML = '';
        } else {
            document.getElementById('carrinho-vazio').classList.add('hidden');
            
            let html = '';
            let total = 0;
            
            CARRINHO.forEach((item, idx) => {
                total += item.preco;
                html += `
                <div class="bg-white p-3 rounded-xl border border-amber-100 flex justify-between items-center">
                    <div>
                        <div class="font-bold text-xs">${item.nome}</div>
                        <div class="text-amber-800 font-black text-sm">R$ ${item.preco.toFixed(2).replace('.',',')}</div>
                    </div>
                    <button onclick="removerCarrinho(${idx})" class="text-red-500 text-xs"><i class="fas fa-trash"></i></button>
                </div>`;
            });
            
            document.getElementById('carrinho-itens-list').innerHTML = html;
            document.getElementById('carrinho-total').innerText = `R$ ${total.toFixed(2).replace('.',',')}`;
        }
        
        document.getElementById('modal-carrinho').classList.remove('hidden');
    };

    window.removerCarrinho = function(idx) {
        CARRINHO.splice(idx, 1);
        atualizarCarrinho();
        abrirCarrinho();
    };

    window.fecharCarrinho = () => document.getElementById('modal-carrinho').classList.add('hidden');

    // ==================== CHECKOUT ====================
    window.checkout = function() {
        fecharCarrinho();
        
        let html = '';
        totalPedido = 0;
        
        CARRINHO.forEach(item => {
            totalPedido += item.preco;
            html += `
            <div class="flex justify-between border-b border-amber-100 pb-2">
                <span class="font-black text-xs">${item.nome}</span>
                <span class="text-amber-800 font-black">R$ ${item.preco.toFixed(2).replace('.',',')}</span>
            </div>`;
        });
        
        document.getElementById('checkout-itens-list').innerHTML = html;
        document.getElementById('res-total').innerText = `R$ ${totalPedido.toFixed(2).replace('.',',')}`;
        
        document.getElementById('f-pag').addEventListener('change', (e) => {
            document.getElementById('div-troco').classList.toggle('hidden', e.target.value !== 'Dinheiro');
        });
        
        document.getElementById('modal-checkout').classList.remove('hidden');
    };

    window.fecharCheckout = () => document.getElementById('modal-checkout').classList.add('hidden');

    window.aplicarCupom = function() {
        const codigo = document.getElementById('f-cupom').value.toUpperCase().trim();
        if (!codigo) return;
        
        const cupom = CUPONS.find(c => c.codigo === codigo && c.ativo !== false);
        if (!cupom) {
            notificar('Erro', 'Cupom inv√°lido', 'erro');
            return;
        }
        
        desconto = cupom.valor || 0;
        cupomAplicado = cupom;
        
        document.getElementById('div-desconto-txt').classList.remove('hidden');
        document.getElementById('txt-val-cupom').innerText = `-R$ ${desconto.toFixed(2).replace('.',',')}`;
        
        const final = Math.max(0, totalPedido - desconto);
        document.getElementById('res-total').innerText = `R$ ${final.toFixed(2).replace('.',',')}`;
        
        notificar('Cupom', `Desconto de R$ ${desconto.toFixed(2).replace('.',',')} aplicado!`, 'sucesso');
    };

    window.finalizarPedido = async function() {
        const nome = document.getElementById('f-nome').value.trim();
        const whatsapp = document.getElementById('f-whatsapp').value.replace(/\D/g, '');
        
        if (!nome || whatsapp.length < 10) {
            notificar('Erro', 'Preencha nome e WhatsApp corretamente', 'erro');
            return;
        }

        const rua = document.getElementById('f-rua').value.trim();
        const numero = document.getElementById('f-num').value.trim();
        const bairro = document.getElementById('f-bairro').value.trim();
        
        if (!rua || !numero || !bairro) {
            notificar('Erro', 'Preencha o endere√ßo completo', 'erro');
            return;
        }

        prog('Enviando pedido...');

        try {
            const pedido = {
                cliente: nome,
                whatsapp: whatsapp,
                endereco: `${rua}, ${numero} - ${bairro}`,
                complemento: document.getElementById('f-comp').value || '',
                pagamento: document.getElementById('f-pag').value,
                troco: document.getElementById('f-troco').value || 'N√£o solicitado',
                itens: CARRINHO.map(i => ({ nome: i.nome, preco: i.preco })),
                subtotal: totalPedido,
                desconto: desconto,
                total: Math.max(0, totalPedido - desconto),
                cupom: cupomAplicado?.codigo,
                status: 'Novo',
                created_at: new Date().toISOString()
            };

            const docRef = await firebase.addDoc(collection(window.db, "pedidos"), pedido);
            
            notificar('Sucesso', 'Pedido realizado com sucesso!', 'sucesso');
            
            CARRINHO = [];
            desconto = 0;
            cupomAplicado = null;
            atualizarCarrinho();
            fecharCheckout();
            
            // Redirecionar para acompanhamento
            window.location.href = `?pedido=${docRef.id}`;
            
        } catch (error) {
            console.error("Erro ao salvar pedido:", error);
            progEsconder();
            notificar('Erro', 'Falha ao enviar pedido', 'erro');
        }
    };

    // ==================== ADMIN ====================
    window.ativarAba = function(aba) {
        document.querySelectorAll('[id^="tab-"]').forEach(t => {
            t.classList.remove('tab-active');
            t.classList.add('text-gray-400');
        });
        document.getElementById(`tab-${aba}`).classList.add('tab-active');
        document.getElementById(`tab-${aba}`).classList.remove('text-gray-400');
        
        document.querySelectorAll('[id^="sec-"]').forEach(s => s.classList.add('hidden'));
        document.getElementById(`sec-${aba}`)?.classList.remove('hidden');
        
        if (aba === 'pedidos') carregarPedidos();
        if (aba === 'produtos') renderProdutosAdmin();
        if (aba === 'categorias') renderCategoriasAdmin();
        if (aba === 'cupons') renderCuponsAdmin();
        if (aba === 'config') renderConfigAdmin();
    };

    async function carregarPedidos() {
        try {
            const q = query(collection(window.db, "pedidos"), orderBy("created_at", "desc"), limit(50));
            const snapshot = await firebase.getDocs(q);
            PEDIDOS = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
            
            let html = '';
            PEDIDOS.forEach(p => {
                const data = new Date(p.created_at).toLocaleString('pt-BR');
                html += `
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-8 border-amber-800">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold">${p.cliente}</span>
                        <span class="text-xs bg-amber-100 px-2 py-1 rounded-full">${p.status}</span>
                    </div>
                    <div class="text-xs text-gray-500 mb-2">${data}</div>
                    <div class="text-xs mb-2">${p.itens.length} itens ‚Ä¢ Total: R$ ${p.total.toFixed(2).replace('.',',')}</div>
                    <div class="flex gap-2">
                        <select onchange="atualizarStatus('${p.id}', this.value)" class="text-xs bg-gray-100 p-1 rounded">
                            <option value="Novo" ${p.status === 'Novo' ? 'selected' : ''}>Novo</option>
                            <option value="Preparando" ${p.status === 'Preparando' ? 'selected' : ''}>Preparando</option>
                            <option value="Saiu" ${p.status === 'Saiu' ? 'selected' : ''}>Saiu</option>
                            <option value="Entregue" ${p.status === 'Entregue' ? 'selected' : ''}>Entregue</option>
                        </select>
                        <button onclick="imprimirPedido('${p.id}')" class="text-xs bg-gray-200 px-2 py-1 rounded">üñ®Ô∏è</button>
                    </div>
                </div>`;
            });
            
            document.getElementById('sec-pedidos').innerHTML = html || '<div class="text-center py-10 text-gray-400">Nenhum pedido encontrado</div>';
        } catch (e) {
            console.error("Erro ao carregar pedidos:", e);
        }
    }

    window.atualizarStatus = async function(id, status) {
        try {
            await firebase.updateDoc(doc(window.db, "pedidos", id), { status });
            notificar('Status', `Pedido atualizado para ${status}`, 'sucesso');
            carregarPedidos();
        } catch (e) {
            notificar('Erro', 'Falha ao atualizar status', 'erro');
        }
    };

    // ==================== SINCRONIZAR CARD√ÅPIO ====================
    window.sincronizarCardapio = async function() {
        if (!usuarioAtual) {
            notificar('Erro', 'Fa√ßa login primeiro', 'erro');
            return;
        }

        if (!confirm('Isso ir√° recriar todo o card√°pio. Continuar?')) return;

        prog('Sincronizando card√°pio...');

        try {
            // Apagar dados existentes
            progAtualizar(10, 'Apagando dados antigos...');
            
            const produtosSnap = await firebase.getDocs(collection(window.db, "produtos"));
            for (const doc of produtosSnap.docs) await firebase.deleteDoc(doc.ref);
            
            const catsSnap = await firebase.getDocs(collection(window.db, "categorias"));
            for (const doc of catsSnap.docs) await firebase.deleteDoc(doc.ref);
            
            const cuponsSnap = await firebase.getDocs(collection(window.db, "cupons"));
            for (const doc of cuponsSnap.docs) await firebase.deleteDoc(doc.ref);

            // Criar categorias
            progAtualizar(30, 'Criando categorias...');
            
            const categorias = [
                { nome: "Carnes na Brasa", ordem: 1 },
                { nome: "Pratos Feitos (PF)", ordem: 2 },
                { nome: "Acompanhamentos", ordem: 3 },
                { nome: "Por√ß√µes para Compartilhar", ordem: 4 },
                { nome: "Bebidas", ordem: 5 }
            ];

            const CATS = {};
            for (let i = 0; i < categorias.length; i++) {
                const docRef = await firebase.addDoc(collection(window.db, "categorias"), categorias[i]);
                CATS[categorias[i].nome] = docRef.id;
            }

            // Criar produtos
            progAtualizar(50, 'Criando produtos...');

            const produtos = [
                // Carnes
                { nome: "Picanha na Brasa (300g)", descricao: "Corte nobre grelhado no ponto ideal. Acompanha farofa e vinagrete.", preco: 89.90, categoria: "Carnes na Brasa", imagem: "https://images.unsplash.com/photo-1558030089-58c1a5c3a7f0?w=400" },
                { nome: "Alcatra Grelhada (350g)", descricao: "Macia e suculenta, finalizada com sal grosso. Acompanha mandioca.", preco: 75.00, categoria: "Carnes na Brasa", imagem: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400" },
                { nome: "Contra-fil√© na Brasa (300g)", descricao: "Cl√°ssico do churrasco brasileiro. Servido com farofa.", preco: 69.90, categoria: "Carnes na Brasa", imagem: "https://images.unsplash.com/photo-1529193591184-b1d58069ecdd?w=400" },
                { nome: "Fraldinha Premium (400g)", descricao: "Assada lentamente. Acompanha chimichurri.", preco: 79.90, categoria: "Carnes na Brasa", imagem: "https://images.unsplash.com/photo-1603360946369-dc9bb6258143?w=400" },
                { nome: "Costela Assada (8h)", descricao: "Assada at√© desmanchar. Servida com mandioca.", preco: 85.00, categoria: "Carnes na Brasa", imagem: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400" },
                { nome: "Lingui√ßa Toscana", descricao: "4 unidades grelhadas na brasa.", preco: 32.90, categoria: "Carnes na Brasa", imagem: "https://images.unsplash.com/photo-1527474006333-5a3acc1ac2a1?w=400" },
                
                // PFs
                { nome: "PF Picanha", descricao: "Picanha + arroz + feij√£o + farofa + vinagrete.", preco: 42.90, categoria: "Pratos Feitos (PF)", imagem: "https://images.unsplash.com/photo-1632778149955-e80f8ceca2e8?w=400" },
                { nome: "PF Costela", descricao: "Costela desfiada + arroz + feij√£o + pur√™.", preco: 38.90, categoria: "Pratos Feitos (PF)", imagem: "https://images.unsplash.com/photo-1632778149955-e80f8ceca2e8?w=400" },
                { nome: "PF Frango", descricao: "Frango + arroz + feij√£o + salada.", preco: 32.90, categoria: "Pratos Feitos (PF)", imagem: "https://images.unsplash.com/photo-1632778149955-e80f8ceca2e8?w=400" },
                { nome: "PF Misto", descricao: "Alcatra + lingui√ßa + arroz + feij√£o + fritas.", preco: 45.90, categoria: "Pratos Feitos (PF)", imagem: "https://images.unsplash.com/photo-1632778149955-e80f8ceca2e8?w=400" },
                
                // Acompanhamentos
                { nome: "Arroz Branco", descricao: "Por√ß√£o individual.", preco: 8.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1516684732162-798a006e2b99?w=400" },
                { nome: "Feij√£o Carioca", descricao: "Por√ß√£o individual.", preco: 8.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1546069901-ba9599a7e63c?w=400" },
                { nome: "Farofa Especial", descricao: "Com bacon e ovos.", preco: 7.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1604329760661-e71dc83f8f26?w=400" },
                { nome: "Vinagrete", descricao: "Molho tradicional.", preco: 6.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1604329760661-e71dc83f8f26?w=400" },
                { nome: "Batata Frita", descricao: "Por√ß√£o crocante.", preco: 18.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1630384060421-cb20d0e0649d?w=400" },
                { nome: "Mandioca Frita", descricao: "Por√ß√£o.", preco: 16.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1604329760661-e71dc83f8f26?w=400" },
                { nome: "Salada Completa", descricao: "Mix de folhas.", preco: 14.90, categoria: "Acompanhamentos", imagem: "https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=400" },
                
                // Por√ß√µes
                { nome: "Por√ß√£o Mista da Casa", descricao: "Picanha + lingui√ßa + frango + fritas + farofa. Serve 2-3 pessoas.", preco: 129.90, categoria: "Por√ß√µes para Compartilhar", imagem: "https://images.unsplash.com/photo-1555939594-58d7cb561ad1?w=400" },
                { nome: "Costela com Mandioca", descricao: "Costela desfiada com mandioca. Serve 2.", preco: 89.90, categoria: "Por√ß√µes para Compartilhar", imagem: "https://images.unsplash.com/photo-1544025162-d76694265947?w=400" },
                { nome: "Lingui√ßa Acebolada", descricao: "Lingui√ßa com cebola. Serve 2.", preco: 48.90, categoria: "Por√ß√µes para Compartilhar", imagem: "https://images.unsplash.com/photo-1527474006333-5a3acc1ac2a1?w=400" },
                
                // Bebidas
                { nome: "Coca-Cola Lata", descricao: "350ml", preco: 6.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=400" },
                { nome: "Guaran√° Lata", descricao: "350ml", preco: 6.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=400" },
                { nome: "Coca-Cola 2L", descricao: "", preco: 14.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1622483767028-3f66f32aef97?w=400" },
                { nome: "Suco Natural", descricao: "500ml - Laranja/Lim√£o/Maracuj√°", preco: 12.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1613478225719-02e6d3063a1a?w=400" },
                { nome: "√Ågua 500ml", descricao: "Com ou sem g√°s", preco: 4.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1564419320467-6876feb6e6d6?w=400" },
                { nome: "Cerveja Lata", descricao: "Skol/Brahma/Antarctica", preco: 7.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1608270586620-248524c67de9?w=400" },
                { nome: "Heineken Long Neck", descricao: "", preco: 12.90, categoria: "Bebidas", imagem: "https://images.unsplash.com/photo-1608270586620-248524c67de9?w=400" }
            ];

            for (let i = 0; i < produtos.length; i++) {
                const prod = produtos[i];
                const catId = CATS[prod.categoria];
                if (!catId) continue;
                
                await firebase.addDoc(collection(window.db, "produtos"), {
                    nome: prod.nome,
                    descricao: prod.descricao,
                    preco: prod.preco,
                    categoria_id: catId,
                    imagem_url: prod.imagem,
                    disponivel: true
                });
                
                progAtualizar(50 + Math.floor((i + 1) / produtos.length * 45), `Produto ${i+1}/${produtos.length}`);
            }

            // Criar cupom
            progAtualizar(95, 'Criando cupom...');
            await firebase.addDoc(collection(window.db, "cupons"), {
                codigo: "GRILL10",
                valor: 10.00,
                ativo: true
            });

            progAtualizar(100, 'Conclu√≠do!');
            
            setTimeout(() => {
                progEsconder();
                notificar('Sucesso', 'Card√°pio sincronizado!', 'sucesso');
                carregarCategorias();
                carregarProdutos();
            }, 1000);

        } catch (error) {
            console.error(error);
            progEsconder();
            notificar('Erro', error.message, 'erro');
        }
    };

    // Fun√ß√µes admin placeholder
    function renderProdutosAdmin() {
        document.getElementById('sec-produtos').innerHTML = '<div class="text-center py-10 text-gray-400">Gest√£o de produtos em desenvolvimento</div>';
    }
    
    function renderCategoriasAdmin() {
        document.getElementById('sec-categorias').innerHTML = '<div class="text-center py-10 text-gray-400">Gest√£o de categorias em desenvolvimento</div>';
    }
    
    function renderCuponsAdmin() {
        document.getElementById('sec-cupons').innerHTML = '<div class="text-center py-10 text-gray-400">Gest√£o de cupons em desenvolvimento</div>';
    }
    
    function renderConfigAdmin() {
        document.getElementById('sec-config').innerHTML = '<div class="text-center py-10 text-gray-400">Configura√ß√µes em desenvolvimento</div>';
    }
    
    window.imprimirPedido = function(id) {
        notificar('Impress√£o', 'Funcionalidade em desenvolvimento', 'info');
    };
    </script>
</body>
</html>